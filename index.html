<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Adivina Qui√©n ‚Äî Friends (Versi√≥n con Aprendizaje)</title>
<style>
  body { font-family: Arial, sans-serif; background: #fafafa; padding: 20px; color: #222; }
  #log { background: #111; color: #eee; padding: 10px; border-radius: 8px; max-height: 250px; overflow:auto; }
  button { margin: 8px; padding: 10px 15px; border: none; border-radius: 6px; background: #3b82f6; color: white; cursor: pointer; }
  h1 { color: #1e40af; }
</style>
</head>
<body>
<h1>Adivina Qui√©n ‚Äî Friends (Aprendizaje Autom√°tico)</h1>

<p>Juego con inferencia hacia adelante y aprendizaje autom√°tico sin usar <code>if</code> tradicionales.</p>

<button id="btnIniciar">Iniciar Juego</button>
<button id="btnPreguntar" disabled>Hacer Pregunta</button>
<div id="pregunta"></div>
<h3>Registro:</h3>
<div id="log"></div>

<script>
/* ------------------------------
   Base de conocimiento
------------------------------ */
function cargarPersonajes() {
  const guardados = localStorage.getItem("personajes_friends");
  if (guardados) return JSON.parse(guardados);
  return [
    { nombre: "Rachel", genero: "femenino", cabello: "casta√±o", trabajo: "moda" },
    { nombre: "Monica", genero: "femenino", cabello: "negro", trabajo: "chef" },
    { nombre: "Phoebe", genero: "femenino", cabello: "rubio", trabajo: "m√∫sica" },
    { nombre: "Ross", genero: "masculino", cabello: "negro", trabajo: "paleont√≥logo" },
    { nombre: "Joey", genero: "masculino", cabello: "casta√±o", trabajo: "actor" },
    { nombre: "Chandler", genero: "masculino", cabello: "casta√±o", trabajo: "oficina" }
  ];
}

let personajes = cargarPersonajes();

/* ------------------------------
   Reglas del sistema experto
------------------------------ */
let reglas = [
  { atributo: "genero", pregunta: p => `¬øTu personaje es ${p}?` },
  { atributo: "cabello", pregunta: c => `¬øTu personaje tiene el cabello ${c}?` },
  { atributo: "trabajo", pregunta: t => `¬øTu personaje trabaja en ${t}?` }
];

/* ------------------------------
   Motor de inferencia
------------------------------ */
class MotorInferencia {
  constructor(personajes, reglas) {
    this.personajes = [...personajes];
    this.reglas = reglas;
    this.hechos = {};
    this.log = [];
  }

  registrar(texto) {
    this.log.unshift(texto);
    document.getElementById("log").innerHTML = this.log.map(l => `<div>${l}</div>`).join("");
  }

  seleccionarRegla() {
    const noAplicadas = this.reglas.filter(r => !(r.atributo in this.hechos));
    return noAplicadas.length ? noAplicadas[Math.floor(Math.random() * noAplicadas.length)] : null;
  }

  aplicarHecho(atributo, valor) {
    this.hechos[atributo] = valor;
    this.personajes = this.personajes.filter(p => p[atributo] === valor);
    this.registrar(`Hecho aprendido: ${atributo} = ${valor}`);
  }

  async hacerPregunta() {
    if (this.personajes.length === 1) {
      const adivina = this.personajes[0].nombre;
      this.registrar(`üéØ ¬°Adivin√©! Es ${adivina}`);
      alert(`Creo que es ${adivina}.`);
      return;
    }

    if (this.personajes.length === 0) {
      this.registrar("‚ùå No encontr√© coincidencias, aprender√© un nuevo personaje.");
      await this.aprenderNuevo();
      return;
    }

    const regla = this.seleccionarRegla();
    if (!regla) {
      this.registrar("No hay m√°s preguntas aplicables.");
      await this.aprenderNuevo();
      return;
    }

    const valores = [...new Set(this.personajes.map(p => p[regla.atributo]))];
    const valor = valores[Math.floor(Math.random() * valores.length)];
    const pregunta = regla.pregunta(valor);

    this.registrar(`Pregunta: ${pregunta}`);
    document.getElementById("pregunta").textContent = pregunta;

    let respuesta = prompt(pregunta + " (s√≠/no)");
    if (!respuesta) return;
    respuesta = respuesta.toLowerCase();

    const mapa = { "s√≠": true, "si": true, "s": true, "no": false, "n": false };
    const afirmativo = mapa[respuesta] ?? false;

    // Sin if: usar filtrado din√°mico
    this.personajes = this.personajes.filter(p => 
      afirmativo ? p[regla.atributo] === valor : p[regla.atributo] !== valor
    );

    if (this.personajes.length <= 1) await this.hacerPregunta();
  }

  async aprenderNuevo() {
    this.registrar("üîç Iniciando modo de aprendizaje...");
    const nombre = prompt("¬øCu√°l era el personaje que pensabas?");
    if (!nombre) return;

    let nuevo = { nombre: nombre.trim() };
    this.registrar(`Aprendiendo nuevo personaje: ${nuevo.nombre}`);

    // Crear los atributos usando las reglas existentes
    this.reglas.forEach(r => {
      let valor = prompt(`¬øCu√°l es el valor de '${r.atributo}' para ${nuevo.nombre}?`);
      nuevo[r.atributo] = valor ? valor.toLowerCase().trim() : "";
    });

    // Guardar el nuevo personaje en localStorage
    personajes.push(nuevo);
    localStorage.setItem("personajes_friends", JSON.stringify(personajes));

    this.registrar(`‚úÖ Nuevo personaje aprendido: ${nuevo.nombre}`);
    alert(`He aprendido un nuevo personaje: ${nuevo.nombre}!`);
  }
}

/* ------------------------------
   Control del juego
------------------------------ */
let motor = new MotorInferencia(personajes, reglas);

document.getElementById("btnIniciar").onclick = () => {
  motor = new MotorInferencia(personajes, reglas);
  motor.registrar("Juego iniciado.");
  document.getElementById("btnPreguntar").disabled = false;
};

document.getElementById("btnPreguntar").onclick = () => motor.hacerPregunta();
</script>
</body>
</html>
